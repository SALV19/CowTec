<%- include('partials/header') %>

<!-- Page Header -->
<%- include('components/molecules/page-header', { 
  title: title,
  subtitle: 'Interactive data visualizations using Apache ECharts',
  icon: 'chart-bar'
}) %>

<div class="row">
    <!-- Chart Navigation Sidebar -->
    <div class="col-md-3">
        <%- include('components/organisms/chart-sidebar', { 
          chartTypes: charts
        }) %>
    </div>

    <!-- Chart Display Area -->
    <div class="col-md-9">
        <%- include('components/molecules/chart-card', { 
          title: 'Select a chart type',
          chartId: 'main-chart',
          height: '400px',
          placeholder: 'Click on a chart type to display it here',
          additionalClasses: 'mb-3'
        }) %>

        <!-- Chart Controls -->
        <%- include('components/molecules/chart-controls') %>
    </div>
</div>

<script>
let currentChart = null;
let currentTheme = 'light';

// Chart navigation event listeners
document.addEventListener('DOMContentLoaded', function() {
    const chartNavs = document.querySelectorAll('.chart-nav');
    
    chartNavs.forEach(nav => {
        nav.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all nav items
            chartNavs.forEach(item => item.classList.remove('active'));
            
            // Add active class to clicked item
            this.classList.add('active');
            
            const chartType = this.dataset.chartType;
            const chartId = this.dataset.chartId;
            
            loadChart(chartType, chartId);
        });
    });
});

async function loadChart(type, chartId) {
    try {
        // Update title
        document.getElementById('current-chart-title').textContent = 
            type.charAt(0).toUpperCase() + type.slice(1) + ' Chart';
        
        // Fetch chart data from controller
        const response = await fetch(`/data/charts/${type}`);
        const chartOption = await response.json();
        
        // Initialize or update chart
        const chartContainer = document.getElementById('main-chart');
        
        if (currentChart) {
            currentChart.dispose();
        }
        
        currentChart = echarts.init(chartContainer, currentTheme);
        currentChart.setOption(chartOption);
        
        // Make chart responsive
        window.addEventListener('resize', function() {
            if (currentChart) {
                currentChart.resize();
            }
        });
        
    } catch (error) {
        console.error('Error loading chart:', error);
        document.getElementById('main-chart').innerHTML = 
            '<div class="alert alert-danger">Error loading chart data</div>';
    }
}

function refreshChart() {
    const activeNav = document.querySelector('.chart-nav.active');
    if (activeNav) {
        const chartType = activeNav.dataset.chartType;
        const chartId = activeNav.dataset.chartId;
        loadChart(chartType, chartId);
    }
}

function downloadChart() {
    if (currentChart) {
        const url = currentChart.getDataURL({
            pixelRatio: 2,
            backgroundColor: '#fff'
        });
        
        const link = document.createElement('a');
        link.download = 'chart.png';
        link.href = url;
        link.click();
    }
}

function toggleTheme() {
    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
    
    const activeNav = document.querySelector('.chart-nav.active');
    if (activeNav) {
        const chartType = activeNav.dataset.chartType;
        const chartId = activeNav.dataset.chartId;
        loadChart(chartType, chartId);
    }
}
</script>

<%- include('partials/footer') %>